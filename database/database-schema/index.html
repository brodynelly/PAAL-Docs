
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://brodynelly.github.io/PAAL-Docs/database/database-schema/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Database Schema - PAAL Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#database-schema" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="PAAL Documentation" class="md-header__button md-logo" aria-label="PAAL Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PAAL Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Database Schema
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PAAL Documentation" class="md-nav__button md-logo" aria-label="PAAL Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PAAL Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gettingstarted/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Frontend
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Frontend
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/overall-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overall Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/key-components/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Key Components and Structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/api-interactions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Interactions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/state-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    State Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Backend
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Backend
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/overall-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overall Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/service-decomposition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Services Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/api-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/data-access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Access Layer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/security-measures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security Measures
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      Why MongoDB?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-design-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Database Design Principles
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#collections-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Collections Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#collection-schemas" class="md-nav__link">
    <span class="md-ellipsis">
      Collection Schemas
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Collection Schemas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pigs-collection" class="md-nav__link">
    <span class="md-ellipsis">
      Pigs Collection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pigs Collection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#field-details" class="md-nav__link">
    <span class="md-ellipsis">
      Field Details
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample-document" class="md-nav__link">
    <span class="md-ellipsis">
      Sample Document
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Common Queries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Validation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#farms-collection" class="md-nav__link">
    <span class="md-ellipsis">
      Farms Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#barns-collection" class="md-nav__link">
    <span class="md-ellipsis">
      Barns Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stalls-collection" class="md-nav__link">
    <span class="md-ellipsis">
      Stalls Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#users-collection" class="md-nav__link">
    <span class="md-ellipsis">
      Users Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#posturedata-collection" class="md-nav__link">
    <span class="md-ellipsis">
      PostureData Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pighealthstatus-collection" class="md-nav__link">
    <span class="md-ellipsis">
      PigHealthStatus Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pigbcs-collection" class="md-nav__link">
    <span class="md-ellipsis">
      PigBCS Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#devices-collection" class="md-nav__link">
    <span class="md-ellipsis">
      Devices Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temperaturedata-collection" class="md-nav__link">
    <span class="md-ellipsis">
      TemperatureData Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activitylog-collection" class="md-nav__link">
    <span class="md-ellipsis">
      ActivityLog Collection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relationships" class="md-nav__link">
    <span class="md-ellipsis">
      Relationships
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Relationships">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#one-to-many-relationships" class="md-nav__link">
    <span class="md-ellipsis">
      One-to-Many Relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#many-to-one-relationships" class="md-nav__link">
    <span class="md-ellipsis">
      Many-to-One Relationships
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Indexing Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Indexing Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#index-types-and-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Index Types and Usage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Index Types and Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-field-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Single Field Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compound-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Compound Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Text Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geospatial-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Geospatial Indexes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#partial-indexes" class="md-nav__link">
    <span class="md-ellipsis">
      Partial Indexes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-design-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Index Design Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Index Design Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#query-pattern-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Query Pattern Analysis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-balancing" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Balancing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      Index Maintenance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-implementation-example" class="md-nav__link">
    <span class="md-ellipsis">
      Index Implementation Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#index-performance-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Index Performance Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Data Validation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-migration-and-versioning" class="md-nav__link">
    <span class="md-ellipsis">
      Data Migration and Versioning
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Migration and Versioning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-versioning" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Versioning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-types" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Migration Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-additive-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      1. Additive Migrations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-transformative-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      2. Transformative Migrations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-structural-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      3. Structural Migrations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-collection-migrations" class="md-nav__link">
    <span class="md-ellipsis">
      4. Collection Migrations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Framework
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-execution-process" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Execution Process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-command-line-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Command Line Tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema-evolution-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Schema Evolution Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Schema Evolution Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pigs-collection-evolution" class="md-nav__link">
    <span class="md-ellipsis">
      Pigs Collection Evolution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-migration-script" class="md-nav__link">
    <span class="md-ellipsis">
      Example Migration Script
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backup-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Backup and Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backup and Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backup-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Backup Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backup Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-full-backups" class="md-nav__link">
    <span class="md-ellipsis">
      1. Full Backups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-incremental-backups" class="md-nav__link">
    <span class="md-ellipsis">
      2. Incremental Backups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-replica-set-replication" class="md-nav__link">
    <span class="md-ellipsis">
      3. Replica Set Replication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-cloud-backup-storage" class="md-nav__link">
    <span class="md-ellipsis">
      4. Cloud Backup Storage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recovery-procedures" class="md-nav__link">
    <span class="md-ellipsis">
      Recovery Procedures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Recovery Procedures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-point-in-time-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      1. Point-in-Time Recovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-single-collection-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      2. Single Collection Recovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-document-level-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      3. Document-Level Recovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backup-verification" class="md-nav__link">
    <span class="md-ellipsis">
      Backup Verification
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backup Verification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-automated-verification" class="md-nav__link">
    <span class="md-ellipsis">
      1. Automated Verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-quarterly-recovery-drills" class="md-nav__link">
    <span class="md-ellipsis">
      2. Quarterly Recovery Drills
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disaster-recovery-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Disaster Recovery Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Disaster Recovery Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-recovery-time-objectives-rto" class="md-nav__link">
    <span class="md-ellipsis">
      1. Recovery Time Objectives (RTO)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-recovery-point-objectives-rpo" class="md-nav__link">
    <span class="md-ellipsis">
      2. Recovery Point Objectives (RPO)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-disaster-recovery-procedure" class="md-nav__link">
    <span class="md-ellipsis">
      3. Disaster Recovery Procedure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backup-and-recovery-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Backup and Recovery Monitoring
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backup and Recovery Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-monitoring-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      1. Monitoring Metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-alerting" class="md-nav__link">
    <span class="md-ellipsis">
      2. Alerting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-reporting" class="md-nav__link">
    <span class="md-ellipsis">
      3. Reporting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="database-schema">Database Schema<a class="headerlink" href="#database-schema" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>The PAAL system uses MongoDB as its primary database. MongoDB is a document-oriented NoSQL database that stores data in flexible, JSON-like documents. This document provides a comprehensive description of the database schema, including detailed collection structures, field specifications, relationships, indexing strategies, validation rules, and data management practices.</p>
<h3 id="why-mongodb">Why MongoDB?<a class="headerlink" href="#why-mongodb" title="Permanent link">&para;</a></h3>
<p>MongoDB was chosen for the PAAL system for several key reasons:</p>
<ol>
<li><strong>Flexible Schema</strong>: Allows for easy evolution of data models as requirements change</li>
<li><strong>Document Structure</strong>: Natural fit for hierarchical data like farm → barn → stall relationships</li>
<li><strong>Horizontal Scalability</strong>: Supports sharding for future growth</li>
<li><strong>Rich Query Language</strong>: Powerful query capabilities including aggregation pipeline</li>
<li><strong>Change Streams</strong>: Native support for real-time data updates</li>
<li><strong>Geospatial Support</strong>: Built-in capabilities for location-based queries (for future farm mapping features)</li>
</ol>
<h3 id="database-design-principles">Database Design Principles<a class="headerlink" href="#database-design-principles" title="Permanent link">&para;</a></h3>
<p>The database schema follows these design principles:</p>
<ol>
<li><strong>Denormalization Where Appropriate</strong>: Strategic denormalization to optimize read performance</li>
<li><strong>Normalization for Consistency</strong>: Normalized references for data that changes frequently</li>
<li><strong>Indexing for Query Patterns</strong>: Indexes designed based on actual query patterns</li>
<li><strong>Data Integrity</strong>: Schema validation rules to ensure data consistency</li>
<li><strong>Performance Optimization</strong>: Collection and index design optimized for common operations</li>
<li><strong>Future Scalability</strong>: Design decisions made with future growth in mind</li>
</ol>
<h2 id="collections-overview">Collections Overview<a class="headerlink" href="#collections-overview" title="Permanent link">&para;</a></h2>
<p>The database consists of the following main collections:</p>
<ol>
<li><strong>Pigs</strong>: Stores information about individual pigs</li>
<li><strong>Farms</strong>: Stores information about farms</li>
<li><strong>Barns</strong>: Stores information about barns within farms</li>
<li><strong>Stalls</strong>: Stores information about stalls within barns</li>
<li><strong>Users</strong>: Stores user account information</li>
<li><strong>PostureData</strong>: Stores pig posture measurements</li>
<li><strong>PigHealthStatus</strong>: Stores pig health status records</li>
<li><strong>PigBCS</strong>: Stores body condition score records</li>
<li><strong>Devices</strong>: Stores information about monitoring devices</li>
<li><strong>TemperatureData</strong>: Stores temperature measurements</li>
<li><strong>ActivityLog</strong>: Stores system activity logs</li>
</ol>
<h2 id="collection-schemas">Collection Schemas<a class="headerlink" href="#collection-schemas" title="Permanent link">&para;</a></h2>
<h3 id="pigs-collection">Pigs Collection<a class="headerlink" href="#pigs-collection" title="Permanent link">&para;</a></h3>
<p>Stores information about individual pigs in the system. This is a core collection that maintains the primary data about each pig being monitored.</p>
<h4 id="schema-definition">Schema Definition<a class="headerlink" href="#schema-definition" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">                </span><span class="c1">// Unique pig identifier (integer)</span>
<span class="w">  </span><span class="nx">tag</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                  </span><span class="c1">// Pig tag/name (e.g., &quot;PIG-001&quot;)</span>
<span class="w">  </span><span class="nx">breed</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                </span><span class="c1">// Pig breed (e.g., &quot;Yorkshire&quot;)</span>
<span class="w">  </span><span class="nx">age</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">                  </span><span class="c1">// Age in months</span>
<span class="w">  </span><span class="nx">birthDate</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// Date of birth (if known)</span>
<span class="w">  </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">               </span><span class="c1">// Weight in kilograms</span>
<span class="w">  </span><span class="nx">gender</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">               </span><span class="c1">// Gender (&quot;male&quot;, &quot;female&quot;)</span>
<span class="w">  </span><span class="nx">currentLocation</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w">            </span><span class="c1">// Current location of the pig</span>
<span class="w">    </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">           </span><span class="c1">// Reference to Farm collection</span>
<span class="w">    </span><span class="nx">barnId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">           </span><span class="c1">// Reference to Barn collection</span>
<span class="w">    </span><span class="nx">stallId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="w">           </span><span class="c1">// Reference to Stall collection</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">           </span><span class="c1">// Calculated health risk score (0-1)</span>
<span class="w">  </span><span class="nx">active</span><span class="o">:</span><span class="w"> </span><span class="nb">Boolean</span><span class="p">,</span><span class="w">              </span><span class="c1">// Whether the pig is active in the system</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">               </span><span class="c1">// Current status (&quot;active&quot;, &quot;sold&quot;, &quot;deceased&quot;)</span>
<span class="w">  </span><span class="nx">notes</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                </span><span class="c1">// Additional notes about the pig</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w">                   </span><span class="c1">// Additional metadata</span>
<span class="w">    </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">             </span><span class="c1">// Source of the pig (e.g., &quot;born&quot;, &quot;purchased&quot;)</span>
<span class="w">    </span><span class="nx">purchaseDate</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">         </span><span class="c1">// Date when the pig was purchased (if applicable)</span>
<span class="w">    </span><span class="nx">purchasePrice</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">      </span><span class="c1">// Purchase price (if applicable)</span>
<span class="w">    </span><span class="nx">genetics</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w">                 </span><span class="c1">// Genetic information</span>
<span class="w">      </span><span class="nx">sire</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">             </span><span class="c1">// Father&#39;s tag/ID</span>
<span class="w">      </span><span class="nx">dam</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="w">               </span><span class="c1">// Mother&#39;s tag/ID</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the record was created</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="w">               </span><span class="c1">// When the record was last updated</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="field-details">Field Details<a class="headerlink" href="#field-details" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
<th>Validation Rules</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_id</code></td>
<td>ObjectId</td>
<td>Yes (auto)</td>
<td>MongoDB's auto-generated unique identifier</td>
<td>Generated by MongoDB</td>
</tr>
<tr>
<td><code>pigId</code></td>
<td>Number</td>
<td>Yes</td>
<td>Unique numeric identifier for the pig</td>
<td>Integer, unique, &gt; 0</td>
</tr>
<tr>
<td><code>tag</code></td>
<td>String</td>
<td>Yes</td>
<td>Human-readable tag/name for the pig</td>
<td>Non-empty string, unique, max 50 chars</td>
</tr>
<tr>
<td><code>breed</code></td>
<td>String</td>
<td>No</td>
<td>Breed of the pig</td>
<td>String, max 100 chars</td>
</tr>
<tr>
<td><code>age</code></td>
<td>Number</td>
<td>No</td>
<td>Age in months</td>
<td>Number ≥ 0</td>
</tr>
<tr>
<td><code>birthDate</code></td>
<td>Date</td>
<td>No</td>
<td>Date of birth if known</td>
<td>Valid date, not in future</td>
</tr>
<tr>
<td><code>weight</code></td>
<td>Number</td>
<td>No</td>
<td>Weight in kilograms</td>
<td>Number &gt; 0</td>
</tr>
<tr>
<td><code>gender</code></td>
<td>String</td>
<td>No</td>
<td>Gender of the pig</td>
<td>Enum: "male", "female"</td>
</tr>
<tr>
<td><code>currentLocation.farmId</code></td>
<td>ObjectId</td>
<td>Yes</td>
<td>Reference to the farm</td>
<td>Valid ObjectId in Farms collection</td>
</tr>
<tr>
<td><code>currentLocation.barnId</code></td>
<td>ObjectId</td>
<td>No</td>
<td>Reference to the barn</td>
<td>Valid ObjectId in Barns collection</td>
</tr>
<tr>
<td><code>currentLocation.stallId</code></td>
<td>ObjectId</td>
<td>No</td>
<td>Reference to the stall</td>
<td>Valid ObjectId in Stalls collection</td>
</tr>
<tr>
<td><code>healthRisk</code></td>
<td>Number</td>
<td>No</td>
<td>Calculated health risk score</td>
<td>Number between 0 and 1</td>
</tr>
<tr>
<td><code>active</code></td>
<td>Boolean</td>
<td>Yes</td>
<td>Whether the pig is active</td>
<td>Boolean</td>
</tr>
<tr>
<td><code>status</code></td>
<td>String</td>
<td>No</td>
<td>Current status</td>
<td>Enum: "active", "sold", "deceased"</td>
</tr>
<tr>
<td><code>notes</code></td>
<td>String</td>
<td>No</td>
<td>Additional notes</td>
<td>String, max 1000 chars</td>
</tr>
<tr>
<td><code>metadata.source</code></td>
<td>String</td>
<td>No</td>
<td>Source of the pig</td>
<td>String, max 100 chars</td>
</tr>
<tr>
<td><code>metadata.purchaseDate</code></td>
<td>Date</td>
<td>No</td>
<td>Purchase date</td>
<td>Valid date</td>
</tr>
<tr>
<td><code>metadata.purchasePrice</code></td>
<td>Number</td>
<td>No</td>
<td>Purchase price</td>
<td>Number ≥ 0</td>
</tr>
<tr>
<td><code>metadata.genetics.sire</code></td>
<td>String</td>
<td>No</td>
<td>Father's tag/ID</td>
<td>String, max 50 chars</td>
</tr>
<tr>
<td><code>metadata.genetics.dam</code></td>
<td>String</td>
<td>No</td>
<td>Mother's tag/ID</td>
<td>String, max 50 chars</td>
</tr>
<tr>
<td><code>createdAt</code></td>
<td>Date</td>
<td>Yes (auto)</td>
<td>Creation timestamp</td>
<td>Auto-generated</td>
</tr>
<tr>
<td><code>updatedAt</code></td>
<td>Date</td>
<td>Yes (auto)</td>
<td>Last update timestamp</td>
<td>Auto-generated</td>
</tr>
</tbody>
</table>
<h4 id="sample-document">Sample Document<a class="headerlink" href="#sample-document" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;60d21b4667d0d8992e610c85&quot;</span><span class="p">),</span>
<span class="w">  </span><span class="s2">&quot;pigId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1001</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;tag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;PIG-1001&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;breed&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Yorkshire&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;age&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">12</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;birthDate&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2022-06-15T00:00:00.000Z&quot;</span><span class="p">),</span>
<span class="w">  </span><span class="s2">&quot;weight&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">120.5</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;gender&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;female&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;currentLocation&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;farmId&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;60d21b4667d0d8992e610c87&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s2">&quot;barnId&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;60d21b4667d0d8992e610c89&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s2">&quot;stallId&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;60d21b4667d0d8992e610c93&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s2">&quot;healthRisk&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;active&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;active&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;notes&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Excellent health, good breeding candidate&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;metadata&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;source&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;purchased&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;purchaseDate&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2022-06-15T00:00:00.000Z&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s2">&quot;purchasePrice&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;genetics&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;sire&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;BOAR-42&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;dam&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;SOW-123&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s2">&quot;createdAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2022-06-15T10:30:00.000Z&quot;</span><span class="p">),</span>
<span class="w">  </span><span class="s2">&quot;updatedAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2023-01-20T14:15:00.000Z&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="indexes">Indexes<a class="headerlink" href="#indexes" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Index</th>
<th>Fields</th>
<th>Type</th>
<th>Description</th>
<th>Justification</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pigId_1</code></td>
<td><code>{ pigId: 1 }</code></td>
<td>Unique</td>
<td>Efficient lookups by pig ID</td>
<td>Primary lookup field, must be unique</td>
</tr>
<tr>
<td><code>tag_1</code></td>
<td><code>{ tag: 1 }</code></td>
<td>Unique</td>
<td>Efficient lookups by tag</td>
<td>Common lookup field, must be unique</td>
</tr>
<tr>
<td><code>currentLocation.farmId_1</code></td>
<td><code>{ "currentLocation.farmId": 1 }</code></td>
<td>Regular</td>
<td>Query pigs by farm</td>
<td>Common filter for listing pigs by farm</td>
</tr>
<tr>
<td><code>currentLocation.barnId_1</code></td>
<td><code>{ "currentLocation.barnId": 1 }</code></td>
<td>Regular</td>
<td>Query pigs by barn</td>
<td>Common filter for listing pigs by barn</td>
</tr>
<tr>
<td><code>currentLocation.stallId_1</code></td>
<td><code>{ "currentLocation.stallId": 1 }</code></td>
<td>Regular</td>
<td>Query pigs by stall</td>
<td>Common filter for listing pigs by stall</td>
</tr>
<tr>
<td><code>active_1</code></td>
<td><code>{ active: 1 }</code></td>
<td>Regular</td>
<td>Filter active/inactive pigs</td>
<td>Common filter condition</td>
</tr>
<tr>
<td><code>status_1</code></td>
<td><code>{ status: 1 }</code></td>
<td>Regular</td>
<td>Filter by status</td>
<td>Common filter condition</td>
</tr>
<tr>
<td><code>breed_1</code></td>
<td><code>{ breed: 1 }</code></td>
<td>Regular</td>
<td>Filter by breed</td>
<td>Used for breed-specific queries</td>
</tr>
<tr>
<td><code>healthRisk_-1_updatedAt_-1</code></td>
<td><code>{ healthRisk: -1, updatedAt: -1 }</code></td>
<td>Compound</td>
<td>Sort by health risk and update time</td>
<td>Used for health monitoring dashboards</td>
</tr>
<tr>
<td><code>currentLocation.farmId_1_active_1</code></td>
<td><code>{ "currentLocation.farmId": 1, active: 1 }</code></td>
<td>Compound</td>
<td>Filter by farm and active status</td>
<td>Common combined filter</td>
</tr>
</tbody>
</table>
<h4 id="common-queries">Common Queries<a class="headerlink" href="#common-queries" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// Find a specific pig by ID</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="mf">1001</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Find all active pigs in a specific farm</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
<span class="w">  </span><span class="s2">&quot;currentLocation.farmId&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;60d21b4667d0d8992e610c87&quot;</span><span class="p">),</span>
<span class="w">  </span><span class="s2">&quot;active&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="p">})</span>

<span class="c1">// Find pigs with high health risk</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
<span class="w">  </span><span class="s2">&quot;healthRisk&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$gt</span><span class="o">:</span><span class="w"> </span><span class="mf">0.7</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="s2">&quot;active&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Count pigs by breed</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$match</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">active</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$group</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$breed&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$sum</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">$sort</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">])</span>

<span class="c1">// Find pigs in a specific stall</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
<span class="w">  </span><span class="s2">&quot;currentLocation.stallId&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;60d21b4667d0d8992e610c93&quot;</span><span class="p">),</span>
<span class="w">  </span><span class="s2">&quot;active&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="p">})</span>
</code></pre></div>

<h4 id="schema-validation">Schema Validation<a class="headerlink" href="#schema-validation" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">validator</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">$jsonSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;pigId&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tag&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;currentLocation&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">minimum</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a positive integer and is required&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">tag</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">minLength</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">          </span><span class="nx">maxLength</span><span class="o">:</span><span class="w"> </span><span class="mf">50</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a non-empty string up to 50 characters and is required&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">breed</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">maxLength</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a string up to 100 characters if the field exists&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">age</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">minimum</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a non-negative number if the field exists&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">birthDate</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a valid date if the field exists&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">minimum</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a positive number if the field exists&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">gender</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kr">enum</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;male&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;female&quot;</span><span class="p">],</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be either &#39;male&#39; or &#39;female&#39; if the field exists&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">currentLocation</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;farmId&quot;</span><span class="p">],</span>
<span class="w">          </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;objectId&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be an objectId and is required&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">barnId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;objectId&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be an objectId if the field exists&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">stallId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;objectId&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be an objectId if the field exists&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">minimum</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">          </span><span class="nx">maximum</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a number between 0 and 1 if the field exists&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">active</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;bool&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a boolean and is required&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kr">enum</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sold&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;deceased&quot;</span><span class="p">],</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be one of &#39;active&#39;, &#39;sold&#39;, or &#39;deceased&#39; if the field exists&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Additional validation rules for other fields...</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">validationLevel</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">validationAction</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;error&quot;</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="farms-collection">Farms Collection<a class="headerlink" href="#farms-collection" title="Permanent link">&para;</a></h3>
<p>Stores information about farms in the system.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                 </span><span class="c1">// Farm name</span>
<span class="w">  </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">             </span><span class="c1">// Farm location/address</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">          </span><span class="c1">// Farm description</span>
<span class="w">  </span><span class="nx">isActive</span><span class="o">:</span><span class="w"> </span><span class="nb">Boolean</span><span class="p">,</span><span class="w">            </span><span class="c1">// Whether the farm is active</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the record was created</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="w">               </span><span class="c1">// When the record was last updated</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>name</code>: Index for searching farms by name
- <code>isActive</code>: Index for filtering active/inactive farms</p>
<h3 id="barns-collection">Barns Collection<a class="headerlink" href="#barns-collection" title="Permanent link">&para;</a></h3>
<p>Stores information about barns within farms.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                 </span><span class="c1">// Barn name</span>
<span class="w">  </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">             </span><span class="c1">// Reference to Farm collection</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">          </span><span class="c1">// Barn description</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the record was created</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="w">               </span><span class="c1">// When the record was last updated</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>farmId</code>: Index for querying barns by farm
- <code>name</code>: Index for searching barns by name</p>
<h3 id="stalls-collection">Stalls Collection<a class="headerlink" href="#stalls-collection" title="Permanent link">&para;</a></h3>
<p>Stores information about stalls within barns.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                 </span><span class="c1">// Stall name</span>
<span class="w">  </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">             </span><span class="c1">// Reference to Farm collection</span>
<span class="w">  </span><span class="nx">barnId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">             </span><span class="c1">// Reference to Barn collection</span>
<span class="w">  </span><span class="nx">capacity</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">             </span><span class="c1">// Stall capacity (number of pigs)</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">          </span><span class="c1">// Stall description</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the record was created</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="w">               </span><span class="c1">// When the record was last updated</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>farmId</code>: Index for querying stalls by farm
- <code>barnId</code>: Index for querying stalls by barn
- <code>name</code>: Index for searching stalls by name</p>
<h3 id="users-collection">Users Collection<a class="headerlink" href="#users-collection" title="Permanent link">&para;</a></h3>
<p>Stores user account information.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                </span><span class="c1">// User email (unique)</span>
<span class="w">  </span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">             </span><span class="c1">// Hashed password</span>
<span class="w">  </span><span class="nx">firstName</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">            </span><span class="c1">// User&#39;s first name</span>
<span class="w">  </span><span class="nx">lastName</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">             </span><span class="c1">// User&#39;s last name</span>
<span class="w">  </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                 </span><span class="c1">// User role (admin, manager, farmer, viewer)</span>
<span class="w">  </span><span class="nx">isActive</span><span class="o">:</span><span class="w"> </span><span class="nb">Boolean</span><span class="p">,</span><span class="w">            </span><span class="c1">// Whether the user account is active</span>
<span class="w">  </span><span class="nx">lastLogin</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the user last logged in</span>
<span class="w">  </span><span class="nx">assignedFarm</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">       </span><span class="c1">// Reference to Farm collection (for farmers)</span>
<span class="w">  </span><span class="nx">permissions</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nb">String</span><span class="p">],</span><span class="w">        </span><span class="c1">// Array of permission strings</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the record was created</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="w">               </span><span class="c1">// When the record was last updated</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>email</code>: Unique index for user lookup by email
- <code>role</code>: Index for filtering users by role
- <code>assignedFarm</code>: Index for querying users by assigned farm
- <code>isActive</code>: Index for filtering active/inactive users</p>
<h3 id="posturedata-collection">PostureData Collection<a class="headerlink" href="#posturedata-collection" title="Permanent link">&para;</a></h3>
<p>Stores pig posture measurements.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">                </span><span class="c1">// Reference to Pig collection (pigId field)</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the measurement was taken</span>
<span class="w">  </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">                </span><span class="c1">// Posture score (0-5)</span>
<span class="w">                                </span><span class="c1">// 0: Standing</span>
<span class="w">                                </span><span class="c1">// 1: Sitting</span>
<span class="w">                                </span><span class="c1">// 2: Lying on side</span>
<span class="w">                                </span><span class="c1">// 3: Lying on belly</span>
<span class="w">                                </span><span class="c1">// 4: Moving</span>
<span class="w">                                </span><span class="c1">// 5: Other</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>pigId</code>: Index for querying posture data by pig
- <code>timestamp</code>: Index for time-based queries
- <code>pigId_timestamp</code>: Compound index for efficient queries by pig and time</p>
<h3 id="pighealthstatus-collection">PigHealthStatus Collection<a class="headerlink" href="#pighealthstatus-collection" title="Permanent link">&para;</a></h3>
<p>Stores pig health status records.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">                </span><span class="c1">// Reference to Pig collection (pigId field)</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the status was recorded</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">               </span><span class="c1">// Health status (healthy, at risk, critical, no movement)</span>
<span class="w">  </span><span class="nx">notes</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                </span><span class="c1">// Additional notes about the health status</span>
<span class="w">  </span><span class="nx">recordedBy</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="w">          </span><span class="c1">// Reference to User collection (who recorded this)</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>pigId</code>: Index for querying health status by pig
- <code>timestamp</code>: Index for time-based queries
- <code>pigId_timestamp</code>: Compound index for efficient queries by pig and time
- <code>status</code>: Index for filtering by status</p>
<h3 id="pigbcs-collection">PigBCS Collection<a class="headerlink" href="#pigbcs-collection" title="Permanent link">&para;</a></h3>
<p>Stores body condition score records.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">                </span><span class="c1">// Reference to Pig collection (pigId field)</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the score was recorded</span>
<span class="w">  </span><span class="nx">score</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">                </span><span class="c1">// Body condition score (1-5)</span>
<span class="w">  </span><span class="nx">notes</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                </span><span class="c1">// Additional notes about the score</span>
<span class="w">  </span><span class="nx">recordedBy</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="w">          </span><span class="c1">// Reference to User collection (who recorded this)</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>pigId</code>: Index for querying BCS by pig
- <code>timestamp</code>: Index for time-based queries
- <code>pigId_timestamp</code>: Compound index for efficient queries by pig and time</p>
<h3 id="devices-collection">Devices Collection<a class="headerlink" href="#devices-collection" title="Permanent link">&para;</a></h3>
<p>Stores information about monitoring devices.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">deviceId</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">             </span><span class="c1">// Unique device identifier</span>
<span class="w">  </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                 </span><span class="c1">// Device type (temperature, posture, etc.)</span>
<span class="w">  </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w">                   </span><span class="c1">// Device location</span>
<span class="w">    </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">           </span><span class="c1">// Reference to Farm collection</span>
<span class="w">    </span><span class="nx">barnId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">           </span><span class="c1">// Reference to Barn collection</span>
<span class="w">    </span><span class="nx">stallId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="w">           </span><span class="c1">// Reference to Stall collection</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">               </span><span class="c1">// Device status (active, inactive, maintenance)</span>
<span class="w">  </span><span class="nx">lastSeen</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">               </span><span class="c1">// When the device last communicated</span>
<span class="w">  </span><span class="nx">firmware</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">             </span><span class="c1">// Device firmware version</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the record was created</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="w">               </span><span class="c1">// When the record was last updated</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>deviceId</code>: Unique index for device lookup
- <code>location.farmId</code>: Index for querying devices by farm
- <code>location.barnId</code>: Index for querying devices by barn
- <code>location.stallId</code>: Index for querying devices by stall
- <code>status</code>: Index for filtering by status
- <code>type</code>: Index for filtering by device type</p>
<h3 id="temperaturedata-collection">TemperatureData Collection<a class="headerlink" href="#temperaturedata-collection" title="Permanent link">&para;</a></h3>
<p>Stores temperature measurements.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">deviceId</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">             </span><span class="c1">// Reference to Device collection (deviceId field)</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the measurement was taken</span>
<span class="w">  </span><span class="nx">temperature</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">          </span><span class="c1">// Temperature in Celsius</span>
<span class="w">  </span><span class="nx">humidity</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">,</span><span class="w">             </span><span class="c1">// Humidity percentage (optional)</span>
<span class="w">  </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w">                   </span><span class="c1">// Measurement location</span>
<span class="w">    </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">           </span><span class="c1">// Reference to Farm collection</span>
<span class="w">    </span><span class="nx">barnId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">           </span><span class="c1">// Reference to Barn collection</span>
<span class="w">    </span><span class="nx">stallId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="w">           </span><span class="c1">// Reference to Stall collection</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>deviceId</code>: Index for querying temperature data by device
- <code>timestamp</code>: Index for time-based queries
- <code>deviceId_timestamp</code>: Compound index for efficient queries by device and time
- <code>location.farmId</code>: Index for querying temperature data by farm
- <code>location.barnId</code>: Index for querying temperature data by barn
- <code>location.stallId</code>: Index for querying temperature data by stall</p>
<h3 id="activitylog-collection">ActivityLog Collection<a class="headerlink" href="#activitylog-collection" title="Permanent link">&para;</a></h3>
<p>Stores system activity logs.</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">                </span><span class="c1">// MongoDB generated ID</span>
<span class="w">  </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">                 </span><span class="c1">// Activity type (user, pig, farm, etc.)</span>
<span class="w">  </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">               </span><span class="c1">// Action performed (created, updated, deleted, login, etc.)</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">          </span><span class="c1">// Human-readable description of the activity</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w">              </span><span class="c1">// When the activity occurred</span>
<span class="w">  </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">             </span><span class="c1">// Reference to User collection (who performed the action)</span>
<span class="w">  </span><span class="nx">entityId</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w">           </span><span class="c1">// Reference to the affected entity (if applicable)</span>
<span class="w">  </span><span class="nx">ipAddress</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w">            </span><span class="c1">// IP address of the user (for user actions)</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="nb">Object</span><span class="w">              </span><span class="c1">// Additional metadata about the activity</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Indexes:</strong>
- <code>timestamp</code>: Index for time-based queries
- <code>type</code>: Index for filtering by activity type
- <code>action</code>: Index for filtering by action
- <code>userId</code>: Index for querying activities by user
- <code>entityId</code>: Index for querying activities by affected entity</p>
<h2 id="relationships">Relationships<a class="headerlink" href="#relationships" title="Permanent link">&para;</a></h2>
<p>The database schema includes several relationships between collections:</p>
<h3 id="one-to-many-relationships">One-to-Many Relationships<a class="headerlink" href="#one-to-many-relationships" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Farm to Barns</strong>: One farm can have many barns</li>
<li>
<p>Implemented via the <code>farmId</code> field in the Barns collection</p>
</li>
<li>
<p><strong>Barn to Stalls</strong>: One barn can have many stalls</p>
</li>
<li>
<p>Implemented via the <code>barnId</code> field in the Stalls collection</p>
</li>
<li>
<p><strong>Farm to Users</strong>: One farm can have many assigned users</p>
</li>
<li>
<p>Implemented via the <code>assignedFarm</code> field in the Users collection</p>
</li>
<li>
<p><strong>Pig to PostureData</strong>: One pig can have many posture measurements</p>
</li>
<li>
<p>Implemented via the <code>pigId</code> field in the PostureData collection</p>
</li>
<li>
<p><strong>Pig to PigHealthStatus</strong>: One pig can have many health status records</p>
</li>
<li>
<p>Implemented via the <code>pigId</code> field in the PigHealthStatus collection</p>
</li>
<li>
<p><strong>Pig to PigBCS</strong>: One pig can have many body condition score records</p>
</li>
<li>
<p>Implemented via the <code>pigId</code> field in the PigBCS collection</p>
</li>
<li>
<p><strong>User to ActivityLog</strong>: One user can have many activity logs</p>
</li>
<li>Implemented via the <code>userId</code> field in the ActivityLog collection</li>
</ul>
<h3 id="many-to-one-relationships">Many-to-One Relationships<a class="headerlink" href="#many-to-one-relationships" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Pig to Farm/Barn/Stall</strong>: Many pigs can be in one farm/barn/stall</li>
<li>
<p>Implemented via the <code>currentLocation</code> object in the Pigs collection</p>
</li>
<li>
<p><strong>Device to Farm/Barn/Stall</strong>: Many devices can be in one farm/barn/stall</p>
</li>
<li>
<p>Implemented via the <code>location</code> object in the Devices collection</p>
</li>
<li>
<p><strong>TemperatureData to Device</strong>: Many temperature measurements can come from one device</p>
</li>
<li>Implemented via the <code>deviceId</code> field in the TemperatureData collection</li>
</ul>
<h2 id="indexing-strategy">Indexing Strategy<a class="headerlink" href="#indexing-strategy" title="Permanent link">&para;</a></h2>
<p>The database employs a comprehensive indexing strategy to optimize query performance while balancing write performance and storage requirements. This section details the types of indexes used, their purposes, and the considerations that went into their design.</p>
<h3 id="index-types-and-usage">Index Types and Usage<a class="headerlink" href="#index-types-and-usage" title="Permanent link">&para;</a></h3>
<h4 id="single-field-indexes">Single Field Indexes<a class="headerlink" href="#single-field-indexes" title="Permanent link">&para;</a></h4>
<p>Single field indexes are used for simple equality queries, range queries, sorting, and existence checks.</p>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Index</th>
<th>Purpose</th>
<th>Example Query</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Pigs</code></td>
<td><code>{ pigId: 1 }</code></td>
<td>Lookup by pig ID</td>
<td><code>db.pigs.findOne({ pigId: 1001 })</code></td>
</tr>
<tr>
<td><code>Farms</code></td>
<td><code>{ name: 1 }</code></td>
<td>Search farms by name</td>
<td><code>db.farms.find({ name: "Farm 1" })</code></td>
</tr>
<tr>
<td><code>Users</code></td>
<td><code>{ email: 1 }</code></td>
<td>Lookup user by email</td>
<td><code>db.users.findOne({ email: "user@example.com" })</code></td>
</tr>
<tr>
<td><code>PostureData</code></td>
<td><code>{ timestamp: -1 }</code></td>
<td>Sort by timestamp descending</td>
<td><code>db.postureData.find().sort({ timestamp: -1 })</code></td>
</tr>
<tr>
<td><code>Devices</code></td>
<td><code>{ status: 1 }</code></td>
<td>Filter devices by status</td>
<td><code>db.devices.find({ status: "active" })</code></td>
</tr>
</tbody>
</table>
<h4 id="compound-indexes">Compound Indexes<a class="headerlink" href="#compound-indexes" title="Permanent link">&para;</a></h4>
<p>Compound indexes support queries that filter or sort on multiple fields, optimizing complex query patterns.</p>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Index</th>
<th>Purpose</th>
<th>Example Query</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PostureData</code></td>
<td><code>{ pigId: 1, timestamp: -1 }</code></td>
<td>Find posture data for a pig, sorted by time</td>
<td><code>db.postureData.find({ pigId: 1001 }).sort({ timestamp: -1 })</code></td>
</tr>
<tr>
<td><code>Pigs</code></td>
<td><code>{ "currentLocation.farmId": 1, active: 1 }</code></td>
<td>Find active pigs in a farm</td>
<td><code>db.pigs.find({ "currentLocation.farmId": farmId, active: true })</code></td>
</tr>
<tr>
<td><code>ActivityLog</code></td>
<td><code>{ type: 1, timestamp: -1 }</code></td>
<td>Find activities by type, sorted by time</td>
<td><code>db.activityLog.find({ type: "pig" }).sort({ timestamp: -1 })</code></td>
</tr>
<tr>
<td><code>TemperatureData</code></td>
<td><code>{ deviceId: 1, timestamp: -1 }</code></td>
<td>Find temperature data for a device, sorted by time</td>
<td><code>db.temperatureData.find({ deviceId: "DEV-001" }).sort({ timestamp: -1 })</code></td>
</tr>
<tr>
<td><code>PigHealthStatus</code></td>
<td><code>{ pigId: 1, status: 1, timestamp: -1 }</code></td>
<td>Find health records by pig and status</td>
<td><code>db.pigHealthStatus.find({ pigId: 1001, status: "at risk" }).sort({ timestamp: -1 })</code></td>
</tr>
</tbody>
</table>
<h4 id="text-indexes">Text Indexes<a class="headerlink" href="#text-indexes" title="Permanent link">&para;</a></h4>
<p>Text indexes enable full-text search capabilities across text fields.</p>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Index</th>
<th>Purpose</th>
<th>Example Query</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Farms</code></td>
<td><code>{ name: "text", description: "text" }</code></td>
<td>Search farms by name or description</td>
<td><code>db.farms.find({ $text: { $search: "organic dairy" } })</code></td>
</tr>
<tr>
<td><code>Pigs</code></td>
<td><code>{ notes: "text" }</code></td>
<td>Search pig notes for keywords</td>
<td><code>db.pigs.find({ $text: { $search: "breeding candidate" } })</code></td>
</tr>
<tr>
<td><code>ActivityLog</code></td>
<td><code>{ description: "text" }</code></td>
<td>Search activity descriptions</td>
<td><code>db.activityLog.find({ $text: { $search: "health check" } })</code></td>
</tr>
</tbody>
</table>
<h4 id="geospatial-indexes">Geospatial Indexes<a class="headerlink" href="#geospatial-indexes" title="Permanent link">&para;</a></h4>
<p>Geospatial indexes support location-based queries (for future farm mapping features).</p>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Index</th>
<th>Purpose</th>
<th>Example Query</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Farms</code></td>
<td><code>{ geoLocation: "2dsphere" }</code></td>
<td>Find farms near a location</td>
<td><code>db.farms.find({ geoLocation: { $near: { $geometry: { type: "Point", coordinates: [ -73.9667, 40.78 ] }, $maxDistance: 5000 } } })</code></td>
</tr>
</tbody>
</table>
<h4 id="partial-indexes">Partial Indexes<a class="headerlink" href="#partial-indexes" title="Permanent link">&para;</a></h4>
<p>Partial indexes only index a subset of documents, reducing index size and improving performance.</p>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Index</th>
<th>Purpose</th>
<th>Example Query</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Pigs</code></td>
<td><code>{ healthRisk: -1 }</code> with filter <code>{ active: true }</code></td>
<td>Index only active pigs by health risk</td>
<td><code>db.pigs.find({ active: true }).sort({ healthRisk: -1 })</code></td>
</tr>
<tr>
<td><code>Devices</code></td>
<td><code>{ lastSeen: -1 }</code> with filter <code>{ status: "active" }</code></td>
<td>Index only active devices by last seen time</td>
<td><code>db.devices.find({ status: "active" }).sort({ lastSeen: -1 })</code></td>
</tr>
</tbody>
</table>
<h3 id="index-design-considerations">Index Design Considerations<a class="headerlink" href="#index-design-considerations" title="Permanent link">&para;</a></h3>
<h4 id="query-pattern-analysis">Query Pattern Analysis<a class="headerlink" href="#query-pattern-analysis" title="Permanent link">&para;</a></h4>
<p>Indexes are designed based on a thorough analysis of application query patterns:</p>
<ol>
<li><strong>Frequency Analysis</strong>: Indexes prioritize the most frequently executed queries</li>
<li><strong>Performance Profiling</strong>: Slow queries are identified and optimized with appropriate indexes</li>
<li><strong>Query Shape Analysis</strong>: Queries with similar shapes share indexes where possible</li>
</ol>
<h4 id="performance-balancing">Performance Balancing<a class="headerlink" href="#performance-balancing" title="Permanent link">&para;</a></h4>
<p>The indexing strategy balances several performance considerations:</p>
<ol>
<li><strong>Read vs. Write Performance</strong>:</li>
<li>Each index improves read performance but adds overhead to write operations</li>
<li>Collections with high write-to-read ratios have fewer indexes</li>
<li>
<p>Collections with high read-to-write ratios have more comprehensive indexing</p>
</li>
<li>
<p><strong>Index Size and Memory Usage</strong>:</p>
</li>
<li>Total index size is monitored to ensure it fits within available RAM</li>
<li>Compound indexes are designed to support multiple query patterns where possible</li>
<li>
<p>Partial indexes are used to reduce index size for large collections</p>
</li>
<li>
<p><strong>Index Selectivity</strong>:</p>
</li>
<li>More selective fields (with higher cardinality) are placed first in compound indexes</li>
<li>Low-selectivity fields (like boolean flags) are typically not indexed alone</li>
<li>Exception: When low-selectivity fields are frequently used in queries that return small result sets</li>
</ol>
<h4 id="index-maintenance">Index Maintenance<a class="headerlink" href="#index-maintenance" title="Permanent link">&para;</a></h4>
<p>The indexing strategy includes ongoing maintenance procedures:</p>
<ol>
<li><strong>Index Usage Monitoring</strong>:</li>
<li>Regular monitoring of index usage statistics</li>
<li>Unused indexes are identified and removed</li>
<li>
<p>Missing indexes are identified through query performance analysis</p>
</li>
<li>
<p><strong>Index Build Strategy</strong>:</p>
</li>
<li>New indexes are built during low-traffic periods</li>
<li>Background index builds are used for production environments</li>
<li>
<p>Index builds are staggered to minimize impact on system performance</p>
</li>
<li>
<p><strong>Index Optimization</strong>:</p>
</li>
<li>Periodic review and optimization of existing indexes</li>
<li>Consolidation of overlapping indexes</li>
<li>Reindexing when necessary to reduce fragmentation</li>
</ol>
<h3 id="index-implementation-example">Index Implementation Example<a class="headerlink" href="#index-implementation-example" title="Permanent link">&para;</a></h3>
<p>Here's an example of how indexes are created for the Pigs collection:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Create single field indexes</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">tag</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;currentLocation.farmId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;currentLocation.barnId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;currentLocation.stallId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">active</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">breed</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>

<span class="c1">// Create compound indexes</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;currentLocation.farmId&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">active</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>

<span class="c1">// Create text index</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">notes</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="w"> </span><span class="p">});</span>

<span class="c1">// Create partial index</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">partialFilterExpression</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">active</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="index-performance-monitoring">Index Performance Monitoring<a class="headerlink" href="#index-performance-monitoring" title="Permanent link">&para;</a></h3>
<p>The system includes tools for monitoring index performance:</p>
<ol>
<li><strong>Query Profiling</strong>:
   ```javascript
   // Enable profiling for slow queries
   db.setProfilingLevel(1, { slowms: 100 });</li>
</ol>
<p>// Analyze slow queries
   db.system.profile.find({ millis: { $gt: 100 } }).sort({ ts: -1 });
   ```</p>
<ol>
<li><strong>Index Statistics</strong>:
   ```javascript
   // Get index statistics for a collection
   db.pigs.stats().indexSizes;</li>
</ol>
<p>// Get detailed index usage statistics
   db.pigs.aggregate([
     { $indexStats: {} }
   ]);
   ```</p>
<ol>
<li><strong>Explain Plans</strong>:
   <code>javascript
   // Analyze query execution plan
   db.pigs.find({ "currentLocation.farmId": farmId, active: true })
     .sort({ healthRisk: -1 })
     .explain("executionStats");</code></li>
</ol>
<h2 id="data-validation">Data Validation<a class="headerlink" href="#data-validation" title="Permanent link">&para;</a></h2>
<p>MongoDB schema validation is used to ensure data integrity:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">validator</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">$jsonSchema</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;pigId&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tag&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;currentLocation&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be an integer and is required&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">tag</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a string and is required&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">breed</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a string if the field exists&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">age</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">minimum</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a non-negative integer if the field exists&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">currentLocation</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;farmId&quot;</span><span class="p">],</span>
<span class="w">          </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;objectId&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be an objectId and is required&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">barnId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;objectId&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be an objectId if the field exists&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">stallId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;objectId&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be an objectId if the field exists&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">active</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">bsonType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;bool&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;must be a boolean and is required&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>
</code></pre></div>

<h2 id="data-migration-and-versioning">Data Migration and Versioning<a class="headerlink" href="#data-migration-and-versioning" title="Permanent link">&para;</a></h2>
<p>As the application evolves, the database schema needs to change to accommodate new features, fix issues, or improve performance. This section details the comprehensive strategy for managing schema changes and data migrations.</p>
<h3 id="schema-versioning">Schema Versioning<a class="headerlink" href="#schema-versioning" title="Permanent link">&para;</a></h3>
<p>The system maintains a dedicated <code>schemaVersion</code> collection to track the current version of each collection's schema:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Example document in the schemaVersion collection</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pigs&quot;</span><span class="p">,</span><span class="w">                </span><span class="c1">// Collection name</span>
<span class="w">  </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w">                 </span><span class="c1">// Current schema version</span>
<span class="w">  </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Added health risk calculation fields&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// Description of latest change</span>
<span class="w">  </span><span class="s2">&quot;updatedAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2023-06-15T10:30:00.000Z&quot;</span><span class="p">),</span><span class="w">      </span><span class="c1">// When the schema was last updated</span>
<span class="w">  </span><span class="s2">&quot;updatedBy&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;migration-script-v3&quot;</span><span class="p">,</span><span class="w">                    </span><span class="c1">// What updated the schema</span>
<span class="w">  </span><span class="s2">&quot;history&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w">                  </span><span class="c1">// History of schema changes</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Initial schema&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;updatedAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2022-01-10T09:00:00.000Z&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Added metadata fields&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;updatedAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2022-08-22T14:45:00.000Z&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Added health risk calculation fields&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;updatedAt&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2023-06-15T10:30:00.000Z&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="migration-types">Migration Types<a class="headerlink" href="#migration-types" title="Permanent link">&para;</a></h3>
<p>The system supports several types of migrations:</p>
<h4 id="1-additive-migrations">1. Additive Migrations<a class="headerlink" href="#1-additive-migrations" title="Permanent link">&para;</a></h4>
<p>Adding new fields or indexes without modifying existing data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Add a new field to all pigs with a default value</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">updateMany</span><span class="p">(</span>
<span class="w">  </span><span class="p">{},</span><span class="w"> </span><span class="c1">// Match all documents</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;healthRisk&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w">  </span><span class="c1">// Default value</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Add a new index for the new field</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>
</code></pre></div>

<h4 id="2-transformative-migrations">2. Transformative Migrations<a class="headerlink" href="#2-transformative-migrations" title="Permanent link">&para;</a></h4>
<p>Modifying existing data to conform to new schema requirements:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Transform string age values to numbers</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">age</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">pig</span><span class="p">.</span><span class="nx">_id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">age</span><span class="o">:</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">pig</span><span class="p">.</span><span class="nx">age</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>

<h4 id="3-structural-migrations">3. Structural Migrations<a class="headerlink" href="#3-structural-migrations" title="Permanent link">&para;</a></h4>
<p>Changing the structure of documents:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Restructure location data from flat fields to nested object</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
<span class="w">  </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$exists</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nx">barnId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$exists</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nx">stallId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$exists</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="p">}).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">pig</span><span class="p">.</span><span class="nx">_id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;currentLocation&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="nx">pig</span><span class="p">.</span><span class="nx">farmId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">barnId</span><span class="o">:</span><span class="w"> </span><span class="nx">pig</span><span class="p">.</span><span class="nx">barnId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">stallId</span><span class="o">:</span><span class="w"> </span><span class="nx">pig</span><span class="p">.</span><span class="nx">stallId</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">$unset</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">farmId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">barnId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">stallId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>

<h4 id="4-collection-migrations">4. Collection Migrations<a class="headerlink" href="#4-collection-migrations" title="Permanent link">&para;</a></h4>
<p>Moving data between collections:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Move temperature data to a new collection</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">deviceData</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;temperature&quot;</span><span class="w"> </span><span class="p">}).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">temperatureData</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span>
<span class="w">    </span><span class="nx">deviceId</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">deviceId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span>
<span class="w">    </span><span class="nx">temperature</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
<span class="w">    </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">location</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="migration-framework">Migration Framework<a class="headerlink" href="#migration-framework" title="Permanent link">&para;</a></h3>
<p>The system uses a custom migration framework to manage and execute migrations:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Migration script structure</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">migration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">  </span><span class="nx">collection</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pigs&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Add health risk calculation fields&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">up</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Add new fields</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">updateMany</span><span class="p">(</span>
<span class="w">      </span><span class="p">{},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;healthRisk&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;healthFactors&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;posture&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;temperature&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;feeding&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Create new indexes</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Update schema version</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;schemaVersion&quot;</span><span class="p">).</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pigs&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">description</span><span class="p">,</span>
<span class="w">          </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">updatedBy</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;migration-script-v3&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">$push</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
<span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">description</span><span class="p">,</span>
<span class="w">            </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">upsert</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">down</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Remove fields</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">updateMany</span><span class="p">(</span>
<span class="w">      </span><span class="p">{},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$unset</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;healthRisk&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;healthFactors&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Remove indexes</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">dropIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Update schema version</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;schemaVersion&quot;</span><span class="p">).</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pigs&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">          </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">updatedBy</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;migration-rollback-v3&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="migration-execution-process">Migration Execution Process<a class="headerlink" href="#migration-execution-process" title="Permanent link">&para;</a></h3>
<p>Migrations are executed through a controlled process:</p>
<ol>
<li><strong>Development</strong>:</li>
<li>Migrations are developed and tested in development environments</li>
<li>Each migration is stored as a separate JavaScript file with up/down methods</li>
<li>
<p>Migrations are version-controlled in the codebase</p>
</li>
<li>
<p><strong>Testing</strong>:</p>
</li>
<li>Migrations are tested on copies of production data</li>
<li>Both up and down migrations are verified</li>
<li>
<p>Performance impact is assessed</p>
</li>
<li>
<p><strong>Deployment</strong>:</p>
</li>
<li>Migrations are deployed during scheduled maintenance windows</li>
<li>A backup is taken before running migrations</li>
<li>Migrations are run in a transaction where possible</li>
<li>
<p>Application is put in maintenance mode during complex migrations</p>
</li>
<li>
<p><strong>Verification</strong>:</p>
</li>
<li>Data integrity is verified after migration</li>
<li>Application functionality is tested with migrated data</li>
<li>Performance is monitored after migration</li>
</ol>
<h3 id="migration-command-line-tool">Migration Command Line Tool<a class="headerlink" href="#migration-command-line-tool" title="Permanent link">&para;</a></h3>
<p>The system includes a command-line tool for managing migrations:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># List all migrations and their status</span>
node<span class="w"> </span>scripts/migrate.js<span class="w"> </span>list

<span class="c1"># Run pending migrations</span>
node<span class="w"> </span>scripts/migrate.js<span class="w"> </span>up

<span class="c1"># Run specific migration</span>
node<span class="w"> </span>scripts/migrate.js<span class="w"> </span>up<span class="w"> </span>--version<span class="w"> </span><span class="m">3</span><span class="w"> </span>--collection<span class="w"> </span>pigs

<span class="c1"># Rollback last migration</span>
node<span class="w"> </span>scripts/migrate.js<span class="w"> </span>down

<span class="c1"># Rollback to specific version</span>
node<span class="w"> </span>scripts/migrate.js<span class="w"> </span>down<span class="w"> </span>--version<span class="w"> </span><span class="m">2</span><span class="w"> </span>--collection<span class="w"> </span>pigs
</code></pre></div>

<h3 id="schema-evolution-examples">Schema Evolution Examples<a class="headerlink" href="#schema-evolution-examples" title="Permanent link">&para;</a></h3>
<p>Here are examples of how the schema has evolved over time:</p>
<h4 id="pigs-collection-evolution">Pigs Collection Evolution<a class="headerlink" href="#pigs-collection-evolution" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Version</th>
<th>Changes</th>
<th>Migration Script</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Initial schema with basic fields</td>
<td>N/A</td>
</tr>
<tr>
<td>2</td>
<td>Added metadata fields for tracking pig sources</td>
<td><code>migrations/pigs_v2.js</code></td>
</tr>
<tr>
<td>3</td>
<td>Added health risk calculation fields</td>
<td><code>migrations/pigs_v3.js</code></td>
</tr>
<tr>
<td>4</td>
<td>Restructured location data to support hierarchical queries</td>
<td><code>migrations/pigs_v4.js</code></td>
</tr>
</tbody>
</table>
<h4 id="example-migration-script">Example Migration Script<a class="headerlink" href="#example-migration-script" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// migrations/pigs_v3.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">  </span><span class="nx">collection</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pigs&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Add health risk calculation fields&quot;</span><span class="p">,</span>

<span class="w">  </span><span class="nx">up</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Running migration: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="si">}</span><span class="sb"> v</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="si">}</span><span class="sb"> - </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">description</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Step 1: Add new fields with default values</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">updateMany</span><span class="p">(</span>
<span class="w">      </span><span class="p">{},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;healthRisk&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;healthFactors&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;posture&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;temperature&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;feeding&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Added health risk fields to all pigs&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Step 2: Calculate initial health risk values based on existing data</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pigs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">toArray</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">pig</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">pigs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Get latest posture data</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">postureData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;postureData&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="nx">pig</span><span class="p">.</span><span class="nx">pigId</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>

<span class="w">      </span><span class="c1">// Calculate health factors based on posture data</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">postureRisk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">postureData</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Calculate lying percentage</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lyingCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">postureData</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">3</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lyingPercentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">lyingCount</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">postureData</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Higher risk if pig is lying down too much</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lyingPercentage</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">70</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">postureRisk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.3</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lyingPercentage</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">postureRisk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Update pig with calculated risk</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">pig</span><span class="p">.</span><span class="nx">_id</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;healthFactors.posture&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">postureRisk</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;healthRisk&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">postureRisk</span><span class="w"> </span><span class="c1">// Simple calculation for now</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Calculated initial health risk values&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Step 3: Create new indexes</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Created index on healthRisk field&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Step 4: Update schema version</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;schemaVersion&quot;</span><span class="p">).</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pigs&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">description</span><span class="p">,</span>
<span class="w">          </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">updatedBy</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;migration-script-v3&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">$push</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
<span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">description</span><span class="p">,</span>
<span class="w">            </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">upsert</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Updated schema version&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="nx">down</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Rolling back migration: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="si">}</span><span class="sb"> v</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Step 1: Remove indexes</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">dropIndex</span><span class="p">({</span><span class="w"> </span><span class="nx">healthRisk</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Dropped index on healthRisk field&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Step 2: Remove fields</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;pigs&quot;</span><span class="p">).</span><span class="nx">updateMany</span><span class="p">(</span>
<span class="w">      </span><span class="p">{},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$unset</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;healthRisk&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;healthFactors&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Removed health risk fields from all pigs&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Step 3: Update schema version</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&quot;schemaVersion&quot;</span><span class="p">).</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pigs&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">          </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">updatedBy</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;migration-rollback-v3&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Updated schema version&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="backup-and-recovery">Backup and Recovery<a class="headerlink" href="#backup-and-recovery" title="Permanent link">&para;</a></h2>
<p>The PAAL system implements a comprehensive backup and recovery strategy to ensure data durability and availability. This section details the backup procedures, recovery processes, and disaster recovery planning.</p>
<h3 id="backup-strategy">Backup Strategy<a class="headerlink" href="#backup-strategy" title="Permanent link">&para;</a></h3>
<p>The backup strategy employs multiple approaches to ensure data safety:</p>
<h4 id="1-full-backups">1. Full Backups<a class="headerlink" href="#1-full-backups" title="Permanent link">&para;</a></h4>
<p>Full backups capture the entire database state:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Daily full backup script</span>
<span class="c1">#!/bin/bash</span>
<span class="nv">DATE</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s2">&quot;/backup/mongodb/full/</span><span class="nv">$DATE</span><span class="s2">&quot;</span>
<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">&quot;/var/log/mongodb/backup_</span><span class="nv">$DATE</span><span class="s2">.log&quot;</span>

<span class="c1"># Create backup directory</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$BACKUP_DIR</span>

<span class="c1"># Perform backup with compression</span>
mongodump<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>backup_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BACKUP_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--db<span class="w"> </span>paal<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--out<span class="w"> </span><span class="nv">$BACKUP_DIR</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gzip<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>&gt;&gt;<span class="w"> </span><span class="nv">$LOG_FILE</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="c1"># Verify backup</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Verifying backup...&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$LOG_FILE</span>
mongorestore<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb-verify.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>verify_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VERIFY_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--db<span class="w"> </span>paal_verify<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--drop<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gzip<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="nv">$BACKUP_DIR</span>/paal<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--dryRun<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>&gt;&gt;<span class="w"> </span><span class="nv">$LOG_FILE</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="c1"># Rotate backups (keep last 30 days)</span>
find<span class="w"> </span>/backup/mongodb/full<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-mtime<span class="w"> </span>+30<span class="w"> </span>-exec<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</code></pre></div>

<p><strong>Schedule</strong>: Daily at 1:00 AM UTC
<strong>Retention</strong>: 30 days</p>
<h4 id="2-incremental-backups">2. Incremental Backups<a class="headerlink" href="#2-incremental-backups" title="Permanent link">&para;</a></h4>
<p>Incremental backups capture changes since the last backup using the MongoDB oplog:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Hourly incremental backup script</span>
<span class="c1">#!/bin/bash</span>
<span class="nv">DATE</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d_%H<span class="k">)</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s2">&quot;/backup/mongodb/incremental/</span><span class="nv">$DATE</span><span class="s2">&quot;</span>
<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">&quot;/var/log/mongodb/incremental_</span><span class="nv">$DATE</span><span class="s2">.log&quot;</span>
<span class="nv">LAST_TIMESTAMP_FILE</span><span class="o">=</span><span class="s2">&quot;/var/lib/mongodb-backup/last_oplog_timestamp&quot;</span>

<span class="c1"># Create backup directory</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$BACKUP_DIR</span>

<span class="c1"># Get last oplog timestamp</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="nv">$LAST_TIMESTAMP_FILE</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nv">LAST_TIMESTAMP</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="nv">$LAST_TIMESTAMP_FILE</span><span class="k">)</span>
<span class="w">  </span><span class="nv">QUERY</span><span class="o">=</span><span class="s2">&quot;{\&quot;ts\&quot;:{\&quot;\\</span><span class="nv">$gt</span><span class="s2">\&quot;:{\&quot;\\</span><span class="nv">$timestamp</span><span class="s2">\&quot;:{\&quot;t\&quot;:</span><span class="nv">$LAST_TIMESTAMP</span><span class="s2">,\&quot;i\&quot;:1}}}}&quot;</span>
<span class="k">else</span>
<span class="w">  </span><span class="c1"># If no timestamp file exists, get all oplog entries from the last hour</span>
<span class="w">  </span><span class="nv">ONE_HOUR_AGO</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;1 hour ago&quot;</span><span class="w"> </span>+%s<span class="k">)</span>
<span class="w">  </span><span class="nv">QUERY</span><span class="o">=</span><span class="s2">&quot;{\&quot;ts\&quot;:{\&quot;\\</span><span class="nv">$gt</span><span class="s2">\&quot;:{\&quot;\\</span><span class="nv">$timestamp</span><span class="s2">\&quot;:{\&quot;t\&quot;:</span><span class="nv">$ONE_HOUR_AGO</span><span class="s2">,\&quot;i\&quot;:1}}}}&quot;</span>
<span class="k">fi</span>

<span class="c1"># Perform oplog backup</span>
mongodump<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>backup_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BACKUP_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--db<span class="w"> </span><span class="nb">local</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--collection<span class="w"> </span>oplog.rs<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--query<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$QUERY</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--out<span class="w"> </span><span class="nv">$BACKUP_DIR</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gzip<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>&gt;&gt;<span class="w"> </span><span class="nv">$LOG_FILE</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="c1"># Get and save the latest oplog timestamp</span>
<span class="nv">LATEST_TIMESTAMP</span><span class="o">=</span><span class="k">$(</span>mongo<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>backup_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BACKUP_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--quiet<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--eval<span class="w"> </span><span class="s2">&quot;db.getSiblingDB(&#39;local&#39;).oplog.rs.find({}, {ts:1}).sort({ts:-1}).limit(1).next().ts.t&quot;</span><span class="k">)</span>

<span class="nb">echo</span><span class="w"> </span><span class="nv">$LATEST_TIMESTAMP</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$LAST_TIMESTAMP_FILE</span>

<span class="c1"># Rotate incremental backups (keep last 48 hours)</span>
find<span class="w"> </span>/backup/mongodb/incremental<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-mtime<span class="w"> </span>+2<span class="w"> </span>-exec<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</code></pre></div>

<p><strong>Schedule</strong>: Hourly
<strong>Retention</strong>: 48 hours</p>
<h4 id="3-replica-set-replication">3. Replica Set Replication<a class="headerlink" href="#3-replica-set-replication" title="Permanent link">&para;</a></h4>
<p>The MongoDB deployment uses a replica set configuration for real-time data redundancy:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Replica set configuration</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;paal-rs&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;members&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;host&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mongodb-primary.example.com:27017&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;priority&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;host&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mongodb-secondary-1.example.com:27017&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;priority&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;host&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mongodb-secondary-2.example.com:27017&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;priority&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;host&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mongodb-arbiter.example.com:27017&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;arbiterOnly&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="s2">&quot;settings&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;chainingAllowed&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;heartbeatTimeoutSecs&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;electionTimeoutMillis&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;catchUpTimeoutMillis&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">60000</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="4-cloud-backup-storage">4. Cloud Backup Storage<a class="headerlink" href="#4-cloud-backup-storage" title="Permanent link">&para;</a></h4>
<p>Backups are stored in multiple locations:</p>
<ol>
<li><strong>Local Storage</strong>: For fast recovery from common failures</li>
<li><strong>Off-site Storage</strong>: For disaster recovery</li>
<li><strong>Cloud Storage</strong>: Encrypted backups in AWS S3 with lifecycle policies</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># Script to upload backups to AWS S3</span>
<span class="c1">#!/bin/bash</span>
<span class="nv">DATE</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s2">&quot;/backup/mongodb/full/</span><span class="nv">$DATE</span><span class="s2">&quot;</span>
<span class="nv">S3_BUCKET</span><span class="o">=</span><span class="s2">&quot;paal-mongodb-backups&quot;</span>
<span class="nv">S3_PREFIX</span><span class="o">=</span><span class="s2">&quot;full/</span><span class="nv">$DATE</span><span class="s2">&quot;</span>

<span class="c1"># Encrypt backup files</span>
tar<span class="w"> </span>-czf<span class="w"> </span>-<span class="w"> </span><span class="nv">$BACKUP_DIR</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>openssl<span class="w"> </span>enc<span class="w"> </span>-aes-256-cbc<span class="w"> </span>-salt<span class="w"> </span>-pass<span class="w"> </span>file:/etc/mongodb-backup/encryption_key<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>&gt;<span class="w"> </span>/tmp/mongodb_backup_<span class="nv">$DATE</span>.tar.gz.enc

<span class="c1"># Upload to S3</span>
aws<span class="w"> </span>s3<span class="w"> </span>cp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>/tmp/mongodb_backup_<span class="nv">$DATE</span>.tar.gz.enc<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>s3://<span class="nv">$S3_BUCKET</span>/<span class="nv">$S3_PREFIX</span>/mongodb_backup_<span class="nv">$DATE</span>.tar.gz.enc<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--storage-class<span class="w"> </span>STANDARD_IA

<span class="c1"># Clean up</span>
rm<span class="w"> </span>/tmp/mongodb_backup_<span class="nv">$DATE</span>.tar.gz.enc

<span class="c1"># Verify upload</span>
aws<span class="w"> </span>s3api<span class="w"> </span>head-object<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--bucket<span class="w"> </span><span class="nv">$S3_BUCKET</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--key<span class="w"> </span><span class="nv">$S3_PREFIX</span>/mongodb_backup_<span class="nv">$DATE</span>.tar.gz.enc
</code></pre></div>

<h3 id="recovery-procedures">Recovery Procedures<a class="headerlink" href="#recovery-procedures" title="Permanent link">&para;</a></h3>
<p>The system supports multiple recovery scenarios:</p>
<h4 id="1-point-in-time-recovery">1. Point-in-Time Recovery<a class="headerlink" href="#1-point-in-time-recovery" title="Permanent link">&para;</a></h4>
<p>Restore the database to a specific point in time:</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># Point-in-Time Recovery Script</span>

<span class="c1"># Parameters</span>
<span class="nv">TARGET_DATE</span><span class="o">=</span><span class="s2">&quot;2023-06-15&quot;</span>
<span class="nv">TARGET_TIME</span><span class="o">=</span><span class="s2">&quot;14:30:00&quot;</span>
<span class="nv">RESTORE_DB</span><span class="o">=</span><span class="s2">&quot;paal&quot;</span>
<span class="nv">TEMP_DB</span><span class="o">=</span><span class="s2">&quot;paal_restore&quot;</span>

<span class="c1"># Convert target date/time to timestamp</span>
<span class="nv">TARGET_TIMESTAMP</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TARGET_DATE</span><span class="s2"> </span><span class="nv">$TARGET_TIME</span><span class="s2">&quot;</span><span class="w"> </span>+%s<span class="k">)</span>

<span class="c1"># Step 1: Find the most recent full backup before the target time</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="k">$(</span>find<span class="w"> </span>/backup/mongodb/full<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;2023*&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TARGET_DATE</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-1<span class="k">)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$BACKUP_DIR</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;No suitable full backup found before </span><span class="nv">$TARGET_DATE</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Step 2: Restore the full backup to a temporary database</span>
mongorestore<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb-restore.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>restore_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$RESTORE_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--db<span class="w"> </span><span class="nv">$TEMP_DB</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gzip<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="nv">$BACKUP_DIR</span>/<span class="nv">$RESTORE_DB</span>

<span class="c1"># Step 3: Find all incremental backups between the full backup and target time</span>
<span class="nv">FULL_BACKUP_DATE</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="nv">$BACKUP_DIR</span><span class="k">)</span>
<span class="nv">INCREMENTAL_DIRS</span><span class="o">=</span><span class="k">$(</span>find<span class="w"> </span>/backup/mongodb/incremental<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$FULL_BACKUP_DATE</span><span class="s2">*&quot;</span><span class="w"> </span>-o<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TARGET_DATE</span><span class="s2">*&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="k">)</span>

<span class="c1"># Step 4: Apply oplog entries up to the target timestamp</span>
<span class="k">for</span><span class="w"> </span>DIR<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$INCREMENTAL_DIRS</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DIR</span><span class="s2">/local&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Applying oplog entries from </span><span class="nv">$DIR</span><span class="s2">...&quot;</span>

<span class="w">    </span><span class="c1"># Extract and filter oplog entries</span>
<span class="w">    </span>mongorestore<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--host<span class="w"> </span>mongodb-restore.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--username<span class="w"> </span>restore_user<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$RESTORE_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--db<span class="w"> </span><span class="nv">$TEMP_DB</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--oplogReplay<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--oplogLimit<span class="w"> </span><span class="nv">$TARGET_TIMESTAMP</span><span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--gzip<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="nv">$DIR</span>/local
<span class="w">  </span><span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># Step 5: Verify the restored data</span>
mongo<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb-restore.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>restore_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$RESTORE_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--eval<span class="w"> </span><span class="s2">&quot;db.getSiblingDB(&#39;</span><span class="nv">$TEMP_DB</span><span class="s2">&#39;).stats()&quot;</span>

<span class="c1"># Step 6: Rename the temporary database to the target database</span>
mongo<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb-restore.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>restore_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$RESTORE_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--eval<span class="w"> </span><span class="s2">&quot;db.adminCommand({renameCollection: &#39;</span><span class="nv">$TEMP_DB</span><span class="s2">.pigs&#39;, to: &#39;</span><span class="nv">$RESTORE_DB</span><span class="s2">.pigs&#39;})&quot;</span>
</code></pre></div>

<h4 id="2-single-collection-recovery">2. Single Collection Recovery<a class="headerlink" href="#2-single-collection-recovery" title="Permanent link">&para;</a></h4>
<p>Restore a specific collection without affecting others:</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># Single Collection Recovery Script</span>

<span class="c1"># Parameters</span>
<span class="nv">COLLECTION</span><span class="o">=</span><span class="s2">&quot;pigs&quot;</span>
<span class="nv">BACKUP_DATE</span><span class="o">=</span><span class="s2">&quot;20230615&quot;</span>
<span class="nv">RESTORE_DB</span><span class="o">=</span><span class="s2">&quot;paal&quot;</span>

<span class="c1"># Step 1: Restore only the specified collection</span>
mongorestore<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb-restore.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>restore_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$RESTORE_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--db<span class="w"> </span><span class="nv">$RESTORE_DB</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--collection<span class="w"> </span><span class="nv">$COLLECTION</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gzip<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>/backup/mongodb/full/<span class="nv">$BACKUP_DATE</span>/<span class="nv">$RESTORE_DB</span>/<span class="nv">$COLLECTION</span>.bson.gz
</code></pre></div>

<h4 id="3-document-level-recovery">3. Document-Level Recovery<a class="headerlink" href="#3-document-level-recovery" title="Permanent link">&para;</a></h4>
<p>Restore specific documents based on query criteria:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Document-Level Recovery Process</span>

<span class="c1">// Step 1: Restore the collection to a temporary collection</span>
<span class="c1">// (Using mongorestore command from previous example, but with a different target collection)</span>

<span class="c1">// Step 2: Identify and copy the documents to recover</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">getSiblingDB</span><span class="p">(</span><span class="s1">&#39;paal_restore&#39;</span><span class="p">).</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
<span class="w">  </span><span class="nx">pigId</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">$in</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1001</span><span class="p">,</span><span class="w"> </span><span class="mf">1002</span><span class="p">,</span><span class="w"> </span><span class="mf">1003</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="p">}).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Check if document exists in the target collection</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">existingDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">getSiblingDB</span><span class="p">(</span><span class="s1">&#39;paal&#39;</span><span class="p">).</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existingDoc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Document exists, update it</span>
<span class="w">    </span><span class="nx">db</span><span class="p">.</span><span class="nx">getSiblingDB</span><span class="p">(</span><span class="s1">&#39;paal&#39;</span><span class="p">).</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="nx">doc</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Document doesn&#39;t exist, insert it</span>
<span class="w">    </span><span class="nx">db</span><span class="p">.</span><span class="nx">getSiblingDB</span><span class="p">(</span><span class="s1">&#39;paal&#39;</span><span class="p">).</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Step 3: Clean up the temporary collection</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">getSiblingDB</span><span class="p">(</span><span class="s1">&#39;paal_restore&#39;</span><span class="p">).</span><span class="nx">pigs</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
</code></pre></div>

<h3 id="backup-verification">Backup Verification<a class="headerlink" href="#backup-verification" title="Permanent link">&para;</a></h3>
<p>All backups are verified to ensure they can be successfully restored:</p>
<h4 id="1-automated-verification">1. Automated Verification<a class="headerlink" href="#1-automated-verification" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># Backup Verification Script</span>

<span class="c1"># Parameters</span>
<span class="nv">BACKUP_DATE</span><span class="o">=</span><span class="s2">&quot;20230615&quot;</span>
<span class="nv">VERIFY_DB</span><span class="o">=</span><span class="s2">&quot;paal_verify&quot;</span>

<span class="c1"># Step 1: Restore the backup to a verification database</span>
mongorestore<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb-verify.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>verify_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VERIFY_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--db<span class="w"> </span><span class="nv">$VERIFY_DB</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--drop<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gzip<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>/backup/mongodb/full/<span class="nv">$BACKUP_DATE</span>/paal

<span class="c1"># Step 2: Run verification queries</span>
mongo<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb-verify.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>verify_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VERIFY_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--eval<span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">    // Check document counts</span>
<span class="s2">    const pigCount = db.getSiblingDB(&#39;</span><span class="nv">$VERIFY_DB</span><span class="s2">&#39;).pigs.countDocuments();</span>
<span class="s2">    const farmCount = db.getSiblingDB(&#39;</span><span class="nv">$VERIFY_DB</span><span class="s2">&#39;).farms.countDocuments();</span>
<span class="s2">    const userCount = db.getSiblingDB(&#39;</span><span class="nv">$VERIFY_DB</span><span class="s2">&#39;).users.countDocuments();</span>

<span class="s2">    // Check specific important documents</span>
<span class="s2">    const adminUser = db.getSiblingDB(&#39;</span><span class="nv">$VERIFY_DB</span><span class="s2">&#39;).users.findOne({role: &#39;admin&#39;});</span>
<span class="s2">    const mainFarm = db.getSiblingDB(&#39;</span><span class="nv">$VERIFY_DB</span><span class="s2">&#39;).farms.findOne({name: &#39;Main Farm&#39;});</span>

<span class="s2">    // Print verification results</span>
<span class="s2">    print(&#39;Verification Results:&#39;);</span>
<span class="s2">    print(&#39;Pig Count: &#39; + pigCount);</span>
<span class="s2">    print(&#39;Farm Count: &#39; + farmCount);</span>
<span class="s2">    print(&#39;User Count: &#39; + userCount);</span>
<span class="s2">    print(&#39;Admin User Found: &#39; + (adminUser !== null));</span>
<span class="s2">    print(&#39;Main Farm Found: &#39; + (mainFarm !== null));</span>

<span class="s2">    // Overall verification status</span>
<span class="s2">    const success = pigCount &gt; 0 &amp;&amp; farmCount &gt; 0 &amp;&amp; userCount &gt; 0 &amp;&amp;</span>
<span class="s2">                   adminUser !== null &amp;&amp; mainFarm !== null;</span>
<span class="s2">    print(&#39;Verification &#39; + (success ? &#39;PASSED&#39; : &#39;FAILED&#39;));</span>

<span class="s2">    // Exit with appropriate code</span>
<span class="s2">    quit(success ? 0 : 1);</span>
<span class="s2">  &quot;</span>

<span class="c1"># Step 3: Check the verification result</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Backup verification successful&quot;</span>
<span class="w">  </span><span class="c1"># Send success notification</span>
<span class="w">  </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;message&quot;:&quot;Backup verification successful for &#39;</span><span class="nv">$BACKUP_DATE</span><span class="s1">&#39;&quot;}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://alerts.example.com/api/notify
<span class="k">else</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Backup verification failed&quot;</span>
<span class="w">  </span><span class="c1"># Send failure alert</span>
<span class="w">  </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;message&quot;:&quot;ALERT: Backup verification failed for &#39;</span><span class="nv">$BACKUP_DATE</span><span class="s1">&#39;&quot;}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>https://alerts.example.com/api/alert
<span class="k">fi</span>

<span class="c1"># Step 4: Clean up verification database</span>
mongo<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--host<span class="w"> </span>mongodb-verify.example.com<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--port<span class="w"> </span><span class="m">27017</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>verify_user<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VERIFY_PASSWORD</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--eval<span class="w"> </span><span class="s2">&quot;db.getSiblingDB(&#39;</span><span class="nv">$VERIFY_DB</span><span class="s2">&#39;).dropDatabase()&quot;</span>
</code></pre></div>

<h4 id="2-quarterly-recovery-drills">2. Quarterly Recovery Drills<a class="headerlink" href="#2-quarterly-recovery-drills" title="Permanent link">&para;</a></h4>
<p>The team performs quarterly recovery drills to ensure the recovery procedures work as expected:</p>
<ol>
<li><strong>Full Recovery Drill</strong>: Complete restoration of the database to a test environment</li>
<li><strong>Point-in-Time Recovery Drill</strong>: Restoration to a specific point in time</li>
<li><strong>Disaster Recovery Drill</strong>: Simulation of a complete data center failure</li>
</ol>
<h3 id="disaster-recovery-plan">Disaster Recovery Plan<a class="headerlink" href="#disaster-recovery-plan" title="Permanent link">&para;</a></h3>
<p>The disaster recovery plan outlines the procedures for recovering from catastrophic failures:</p>
<h4 id="1-recovery-time-objectives-rto">1. Recovery Time Objectives (RTO)<a class="headerlink" href="#1-recovery-time-objectives-rto" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Tier 1 (Critical)</strong>: &lt; 1 hour</li>
<li><strong>Tier 2 (Important)</strong>: &lt; 4 hours</li>
<li><strong>Tier 3 (Normal)</strong>: &lt; 24 hours</li>
</ul>
<h4 id="2-recovery-point-objectives-rpo">2. Recovery Point Objectives (RPO)<a class="headerlink" href="#2-recovery-point-objectives-rpo" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Tier 1 (Critical)</strong>: &lt; 5 minutes</li>
<li><strong>Tier 2 (Important)</strong>: &lt; 1 hour</li>
<li><strong>Tier 3 (Normal)</strong>: &lt; 24 hours</li>
</ul>
<h4 id="3-disaster-recovery-procedure">3. Disaster Recovery Procedure<a class="headerlink" href="#3-disaster-recovery-procedure" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="p">#</span><span class="w"> </span><span class="n">Disaster</span><span class="w"> </span><span class="n">Recovery</span><span class="w"> </span><span class="n">Procedure</span>

<span class="p">##</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="w"> </span><span class="n">Assessment</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">Declaration</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">Assess</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">extent</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">disaster</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Declare</span><span class="w"> </span><span class="n">disaster</span><span class="w"> </span><span class="n">recovery</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">primary</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">center</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">unavailable</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Notify</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">stakeholders</span>

<span class="p">##</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mh">2</span><span class="o">:</span><span class="w"> </span><span class="n">Infrastructure</span><span class="w"> </span><span class="n">Provisioning</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">Activate</span><span class="w"> </span><span class="n">standby</span><span class="w"> </span><span class="n">infrastructure</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">secondary</span><span class="w"> </span><span class="n">region</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">connectivity</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Configure</span><span class="w"> </span><span class="n">MongoDB</span><span class="w"> </span><span class="n">servers</span>

<span class="p">##</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="n">Recovery</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">Restore</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">most</span><span class="w"> </span><span class="n">recent</span><span class="w"> </span><span class="n">full</span><span class="w"> </span><span class="n">backup</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">cloud</span><span class="w"> </span><span class="n">storage</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Apply</span><span class="w"> </span><span class="n">incremental</span><span class="w"> </span><span class="n">backups</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">reach</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">latest</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">state</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">integrity</span>

<span class="p">##</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mh">4</span><span class="o">:</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">Recovery</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">Update</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">recovered</span><span class="w"> </span><span class="n">database</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Restart</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="n">services</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="n">functionality</span>

<span class="p">##</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mh">5</span><span class="o">:</span><span class="w"> </span><span class="n">Validation</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">Monitoring</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">Run</span><span class="w"> </span><span class="n">validation</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ensure</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">integrity</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Monitor</span><span class="w"> </span><span class="n">system</span><span class="w"> </span><span class="n">performance</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Verify</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">critical</span><span class="w"> </span><span class="n">business</span><span class="w"> </span><span class="n">functions</span>

<span class="p">##</span><span class="w"> </span><span class="n">Phase</span><span class="w"> </span><span class="mh">6</span><span class="o">:</span><span class="w"> </span><span class="n">Communication</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">Reporting</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">Communicate</span><span class="w"> </span><span class="n">recovery</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">stakeholders</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Document</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">incident</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">recovery</span><span class="w"> </span><span class="n">process</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Conduct</span><span class="w"> </span><span class="n">post</span><span class="o">-</span><span class="n">incident</span><span class="w"> </span><span class="n">review</span>
</code></pre></div>

<h3 id="backup-and-recovery-monitoring">Backup and Recovery Monitoring<a class="headerlink" href="#backup-and-recovery-monitoring" title="Permanent link">&para;</a></h3>
<p>The backup and recovery processes are continuously monitored:</p>
<h4 id="1-monitoring-metrics">1. Monitoring Metrics<a class="headerlink" href="#1-monitoring-metrics" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Backup Success Rate</strong>: Percentage of successful backups</li>
<li><strong>Backup Duration</strong>: Time taken to complete backups</li>
<li><strong>Backup Size</strong>: Size of backup files</li>
<li><strong>Verification Success Rate</strong>: Percentage of successful verifications</li>
<li><strong>Recovery Time</strong>: Time taken to recover in drills</li>
</ul>
<h4 id="2-alerting">2. Alerting<a class="headerlink" href="#2-alerting" title="Permanent link">&para;</a></h4>
<p>Alerts are configured for backup and recovery issues:</p>
<ul>
<li><strong>Failed Backups</strong>: Immediate alert if a backup fails</li>
<li><strong>Backup Size Anomalies</strong>: Alert if backup size changes significantly</li>
<li><strong>Verification Failures</strong>: Alert if backup verification fails</li>
<li><strong>Missed Backups</strong>: Alert if scheduled backups are missed</li>
</ul>
<h4 id="3-reporting">3. Reporting<a class="headerlink" href="#3-reporting" title="Permanent link">&para;</a></h4>
<p>Regular reports are generated to track backup and recovery health:</p>
<ul>
<li><strong>Daily Backup Report</strong>: Summary of all backups in the last 24 hours</li>
<li><strong>Weekly Backup Analysis</strong>: Trends and anomalies in backup metrics</li>
<li><strong>Quarterly Recovery Drill Report</strong>: Results of recovery drills</li>
<li><strong>Annual Disaster Recovery Test Report</strong>: Comprehensive assessment of DR capabilities</li>
</ul>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>The PAAL system's database schema is designed to efficiently store and retrieve data related to pig monitoring and farm management. The schema uses MongoDB's document-oriented approach to provide flexibility while maintaining data integrity through validation rules. Relationships between collections are implemented through reference fields, and indexes are strategically placed to optimize query performance.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    2025-05-08
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/brodynelly/PAAL-Docs" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>